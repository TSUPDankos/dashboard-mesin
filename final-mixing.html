<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Final Mixing </title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .ai-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .machine-card {
            backdrop-filter: blur(10px);
        }
        
        .border-small {
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .border-medium {
            border: 3px solid rgba(255, 255, 255, 0.25);
        }
        
        .border-large {
            border: 4px solid rgba(255, 255, 255, 0.3);
        }
        
        .border-xlarge {
            border: 5px solid rgba(255, 255, 255, 0.35);
        }
        
        .border-xxlarge {
            border: 6px solid rgba(255, 255, 255, 0.4);
        }
        
        .glow-effect {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .machine-image-zoom {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .machine-image-zoom:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
        }
        
        .machine-card-glow {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        .machine-card-glow:hover {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5), 0 0 60px rgba(102, 126, 234, 0.3);
            transform: translateY(-5px);
        }
        
        .detail-modal {
            backdrop-filter: blur(15px);
            background: rgba(0, 0, 0, 0.8);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse-hover:hover {
            animation: pulse 0.6s ease-in-out;
        }
        
        .tab-btn {
            border-bottom-color: transparent;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        
        .tab-btn:hover {
            color: #3b82f6;
        }
        
        .home-tab-btn {
            border-bottom-color: transparent;
            color: #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .home-tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .home-tab-btn:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .part-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .part-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .stock-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .stock-low {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .stock-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .stock-high {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full font-sans">
  <div class="min-h-full ai-gradient"><!-- Header -->
   <header class="text-center py-12 px-4">
    <h1 id="main-title" class="text-5xl font-bold text-white mb-4 fade-in">Final Mixing</h1>
   </header><!-- Main Content -->
   <main class="container mx-auto px-4 pb-12"><!-- Machines Grid -->
    <section class="mb-12">
     <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-white mb-4">Mesin Final Mixing</h2>
      <p class="text-blue-100">Pilih mesin untuk mengelola part dan change part</p>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><!-- SMG Yenchen 400 -->
      <div class="machine-card machine-card-glow border-small bg-white/10 rounded-2xl p-6 text-white fade-in hover:bg-white/15 transition-all duration-300">
       <div class="text-center">
        <div id="smg-image-container" class="w-40 h-40 mx-auto mb-4 rounded-full flex items-center justify-center bg-indigo-600 machine-image-zoom overflow-hidden"><img id="smg-image" src="" alt="SMG Yenchen 400" class="w-40 h-40 object-cover rounded-full hidden machine-image-zoom" onerror="this.style.display='none'; document.getElementById('smg-default-svg').style.display='block';">
         <svg id="smg-default-svg" class="w-20 h-20 text-white machine-image-zoom" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" /> <circle cx="12" cy="8" r="2" /> <path d="M12 14c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
         </svg>
        </div>
        <h3 class="text-xl font-bold mb-4">SMG Yenchen 400</h3>
        <div class="space-y-3 mb-6">
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Kapasitas:</span> <span class="text-white font-semibold">400 Liter</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Tahun:</span> <span class="text-white font-semibold">2023</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Negara:</span> <span class="text-white font-semibold">Taiwan</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Dimensi:</span> <span class="text-white font-semibold text-xs">2000x1500x2200 mm</span>
         </div>
        </div><button onclick="showDetail('smg')" id="detail-btn-1" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 pulse-hover glow-effect"> Detail Lengkap </button>
       </div>
      </div><!-- Zanchetta Roto F-200 -->
      <div class="machine-card machine-card-glow border-medium bg-white/10 rounded-2xl p-6 text-white fade-in hover:bg-white/15 transition-all duration-300">
       <div class="text-center">
        <div id="zanchetta-image-container" class="w-40 h-40 mx-auto mb-4 rounded-full flex items-center justify-center bg-purple-600 machine-image-zoom overflow-hidden"><img id="zanchetta-image" src="" alt="Zanchetta Roto F-200" class="w-40 h-40 object-cover rounded-full hidden machine-image-zoom" onerror="this.style.display='none'; document.getElementById('zanchetta-default-svg').style.display='block';">
         <svg id="zanchetta-default-svg" class="w-20 h-20 text-white machine-image-zoom" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" /> <circle cx="12" cy="12" r="3" /> <path d="M19.07 4.93l-1.41 1.41C19.1 7.79 20 9.79 20 12s-.9 4.21-2.34 5.66l1.41 1.41C20.88 17.26 22 14.76 22 12s-1.12-5.26-2.93-7.07z" />
         </svg>
        </div>
        <h3 class="text-xl font-bold mb-4">Zanchetta Roto F-200</h3>
        <div class="space-y-3 mb-6">
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Kapasitas:</span> <span class="text-white font-semibold">200 Liter</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Tahun:</span> <span class="text-white font-semibold">2022</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Negara:</span> <span class="text-white font-semibold">Italia</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Dimensi:</span> <span class="text-white font-semibold text-xs">1800x1200x1900 mm</span>
         </div>
        </div><button onclick="showDetail('zanchetta')" id="detail-btn-2" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 pulse-hover glow-effect"> Detail Lengkap </button>
       </div>
      </div><!-- Drum Mixer -->
      <div class="machine-card machine-card-glow border-large bg-white/10 rounded-2xl p-6 text-white fade-in hover:bg-white/15 transition-all duration-300">
       <div class="text-center">
        <div id="drum-image-container" class="w-40 h-40 mx-auto mb-4 rounded-full flex items-center justify-center bg-emerald-600 machine-image-zoom overflow-hidden"><img id="drum-image" src="" alt="Drum Mixer" class="w-40 h-40 object-cover rounded-full hidden machine-image-zoom" onerror="this.style.display='none'; document.getElementById('drum-default-svg').style.display='block';">
         <svg id="drum-default-svg" class="w-20 h-20 text-white machine-image-zoom" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" /> <circle cx="12" cy="9" r="2.5" /> <rect x="8" y="15" width="8" height="6" rx="1" /> <path d="M10 18h4M10 20h4" />
         </svg>
        </div>
        <h3 class="text-xl font-bold mb-4">Drum Mixer</h3>
        <div class="space-y-3 mb-6">
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Kapasitas:</span> <span class="text-white font-semibold">300 Liter</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Tahun:</span> <span class="text-white font-semibold">2021</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Negara:</span> <span class="text-white font-semibold">Jerman</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Dimensi:</span> <span class="text-white font-semibold text-xs">2200x1400x1800 mm</span>
         </div>
        </div><button onclick="showDetail('drum')" id="detail-btn-3" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 pulse-hover glow-effect"> Detail Lengkap </button>
       </div>
      </div><!-- Tumbling 800 -->
      <div class="machine-card machine-card-glow border-xlarge bg-white/10 rounded-2xl p-6 text-white fade-in hover:bg-white/15 transition-all duration-300">
       <div class="text-center">
        <div id="tumbling800-image-container" class="w-40 h-40 mx-auto mb-4 rounded-full flex items-center justify-center bg-amber-600 machine-image-zoom overflow-hidden"><img id="tumbling800-image" src="" alt="Tumbling 800" class="w-40 h-40 object-cover rounded-full hidden machine-image-zoom" onerror="this.style.display='none'; document.getElementById('tumbling800-default-svg').style.display='block';">
         <svg id="tumbling800-default-svg" class="w-20 h-20 text-white machine-image-zoom" fill="currentColor" viewbox="0 0 24 24"><circle cx="12" cy="12" r="10" /> <path d="M8 12l2 2 4-4" /> <path d="M12 6V2M6 12H2M18 12h4M12 18v4" /> <circle cx="12" cy="12" r="3" />
         </svg>
        </div>
        <h3 class="text-xl font-bold mb-4">Tumbling 800</h3>
        <div class="space-y-3 mb-6">
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Kapasitas:</span> <span class="text-white font-semibold">800 Liter</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Tahun:</span> <span class="text-white font-semibold">2023</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Negara:</span> <span class="text-white font-semibold">Amerika Serikat</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Dimensi:</span> <span class="text-white font-semibold text-xs">2800x2000x2500 mm</span>
         </div>
        </div><button onclick="showDetail('tumbling800')" id="detail-btn-4" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 pulse-hover glow-effect"> Detail Lengkap </button>
       </div>
      </div><!-- Tumbling 1500 -->
      <div class="machine-card machine-card-glow border-xxlarge bg-white/10 rounded-2xl p-6 text-white fade-in hover:bg-white/15 transition-all duration-300">
       <div class="text-center">
        <div id="tumbling1500-image-container" class="w-40 h-40 mx-auto mb-4 rounded-full flex items-center justify-center bg-red-600 machine-image-zoom overflow-hidden"><img id="tumbling1500-image" src="" alt="Tumbling 1500" class="w-40 h-40 object-cover rounded-full hidden machine-image-zoom" onerror="this.style.display='none'; document.getElementById('tumbling1500-default-svg').style.display='block';">
         <svg id="tumbling1500-default-svg" class="w-20 h-20 text-white machine-image-zoom" fill="currentColor" viewbox="0 0 24 24"><circle cx="12" cy="12" r="10" /> <path d="M9 12l2 2 4-4" /> <rect x="6" y="6" width="12" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /> <circle cx="12" cy="12" r="4" />
         </svg>
        </div>
        <h3 class="text-xl font-bold mb-4">Tumbling 1500</h3>
        <div class="space-y-3 mb-6">
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Kapasitas:</span> <span class="text-white font-semibold">1500 Liter</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Tahun:</span> <span class="text-white font-semibold">2024</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Negara:</span> <span class="text-white font-semibold">Jepang</span>
         </div>
         <div class="flex justify-between"><span class="text-blue-200 text-sm">Dimensi:</span> <span class="text-white font-semibold text-xs">3500x2500x3000 mm</span>
         </div>
        </div><button onclick="showDetail('tumbling1500')" id="detail-btn-5" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 pulse-hover glow-effect"> Detail Lengkap </button>
       </div>
      </div>
     </div><!-- Parts Overview Section -->
     <section class="mt-12">
      <div class="text-center mb-8">
       <h2 class="text-3xl font-bold text-white mb-4">Daftar Part Mesin</h2>
       <p class="text-blue-100">Overview semua part dan change part untuk seluruh mesin</p>
      </div><!-- Quick Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
       <div class="bg-white/10 backdrop-filter backdrop-blur-lg rounded-xl p-4 text-center border border-white/20">
        <div class="text-2xl font-bold text-white mb-1" id="home-total-parts">
         0
        </div>
        <div class="text-blue-100 text-sm">
         Total Parts
        </div>
       </div>
       <div class="bg-white/10 backdrop-filter backdrop-blur-lg rounded-xl p-4 text-center border border-white/20">
        <div class="text-2xl font-bold text-white mb-1" id="home-total-stock">
         0
        </div>
        <div class="text-blue-100 text-sm">
         Total Stok
        </div>
       </div>
       <div class="bg-white/10 backdrop-filter backdrop-blur-lg rounded-xl p-4 text-center border border-white/20">
        <div class="text-2xl font-bold text-white mb-1" id="home-change-parts">
         0
        </div>
        <div class="text-blue-100 text-sm">
         Change Parts
        </div>
       </div>
       <div class="bg-white/10 backdrop-filter backdrop-blur-lg rounded-xl p-4 text-center border border-white/20">
        <div class="text-2xl font-bold text-white mb-1" id="home-low-stock">
         0
        </div>
        <div class="text-blue-100 text-sm">
         Stok Rendah
        </div>
       </div>
      </div><!-- Parts Lists Tabs -->
      <div class="bg-white/10 backdrop-filter backdrop-blur-lg rounded-2xl border border-white/20 overflow-hidden"><!-- Tab Navigation -->
       <div class="border-b border-white/20">
        <nav class="flex"><button onclick="switchHomeTab('parts')" class="home-tab-btn flex-1 py-4 px-6 text-white font-medium border-b-2 border-transparent hover:bg-white/5 transition-all active" data-tab="parts">
          <div class="flex items-center justify-center gap-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
           </svg> Part Mesin
          </div></button> <button onclick="switchHomeTab('change-parts')" class="home-tab-btn flex-1 py-4 px-6 text-white font-medium border-b-2 border-transparent hover:bg-white/5 transition-all" data-tab="change-parts">
          <div class="flex items-center justify-center gap-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
           </svg> Change Parts
          </div></button>
        </nav>
       </div><!-- Tab Content -->
       <div class="p-6"><!-- Parts Tab -->
        <div id="home-tab-parts" class="home-tab-content">
         <div id="home-parts-list" class="space-y-4">
          <div class="text-center py-12 text-white/70">
           <svg class="w-16 h-16 mx-auto mb-4 text-white/50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
           </svg>
           <h3 class="text-lg font-medium mb-2">Belum Ada Part Mesin</h3>
           <p class="text-sm">Klik detail mesin untuk menambahkan part</p>
          </div>
         </div>
        </div><!-- Change Parts Tab -->
        <div id="home-tab-change-parts" class="home-tab-content hidden">
         <div id="home-change-parts-list" class="space-y-4">
          <div class="text-center py-12 text-white/70">
           <svg class="w-16 h-16 mx-auto mb-4 text-white/50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
           </svg>
           <h3 class="text-lg font-medium mb-2">Belum Ada Change Part</h3>
           <p class="text-sm">Klik detail mesin untuk menambahkan change part</p>
          </div>
         </div>
        </div>
       </div>
      </div>
     </section> <!-- Detail Modal -->
     <div id="detailModal" class="fixed inset-0 detail-modal hidden items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
       <div class="p-6">
        <div class="flex justify-between items-center mb-6">
         <h2 id="modalTitle" class="text-3xl font-bold text-gray-800"></h2><button onclick="closeDetail()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
        </div><!-- Tab Navigation -->
        <div class="border-b border-gray-200 mb-6">
         <nav class="flex space-x-8"><button onclick="switchTab('add-part')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm active" data-tab="add-part"> Tambah Part Mesin </button> <button onclick="switchTab('change-part')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="change-part"> Tambah Change Part </button> <button onclick="switchTab('analytics')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="analytics"> Grafik dan Analisa </button>
         </nav>
        </div><!-- Tab Content -->
        <div id="tab-add-part" class="tab-content hidden">
         <div class="bg-gray-50 p-6 rounded-lg">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Tambah Part Mesin Baru</h3>
          <form id="addPartForm" class="space-y-4">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="machineName" class="block text-sm font-medium text-gray-700 mb-1">Nama Mesin</label> <input type="text" id="machineName" name="machineName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="partName" class="block text-sm font-medium text-gray-700 mb-1">Nama Part</label> <input type="text" id="partName" name="partName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="partNumber" class="block text-sm font-medium text-gray-700 mb-1">Part Number</label> <input type="text" id="partNumber" name="partNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="stock" class="block text-sm font-medium text-gray-700 mb-1">Stok</label> <input type="number" id="stock" name="stock" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="vendor" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label> <input type="text" id="vendor" name="vendor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
           </div>
           <div><label for="description" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label> <textarea id="description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
           </div>
           <div class="flex gap-3"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium transition-colors"> Simpan Part </button> <button type="button" onclick="clearForm('addPartForm')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md font-medium transition-colors"> Reset </button>
           </div>
          </form>
         </div><!-- Parts List -->
         <div class="mt-6">
          <div class="flex justify-between items-center mb-4">
           <h4 class="text-lg font-semibold text-gray-800">Daftar Part Mesin</h4>
           <div class="flex gap-2"><button onclick="exportToExcel('parts')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"> Export Excel </button> <input type="file" id="importPartsFile" accept=".xlsx,.xls,.csv" class="hidden" onchange="importFromExcel('parts')"> <button onclick="document.getElementById('importPartsFile').click()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"> Import Excel </button> <button onclick="showImportTemplate('parts')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"> Template Import </button>
           </div>
          </div>
          <div id="partsList" class="bg-white border rounded-lg overflow-hidden">
           <div class="text-center py-8 text-gray-500">
            Belum ada data part mesin
           </div>
          </div>
         </div>
        </div>
        <div id="tab-change-part" class="tab-content hidden">
         <div class="bg-gray-50 p-6 rounded-lg">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Tambah Change Part</h3>
          <form id="changePartForm" class="space-y-4">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="changePartMachine" class="block text-sm font-medium text-gray-700 mb-1">Nama Mesin</label> <input type="text" id="changePartMachine" name="machineName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="changePartName" class="block text-sm font-medium text-gray-700 mb-1">Nama Part</label> <input type="text" id="changePartName" name="partName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="changePartNumber" class="block text-sm font-medium text-gray-700 mb-1">Part Number</label> <input type="text" id="changePartNumber" name="partNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="changeStock" class="block text-sm font-medium text-gray-700 mb-1">Stok</label> <input type="number" id="changeStock" name="stock" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div><label for="changeVendor" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label> <input type="text" id="changeVendor" name="vendor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
           </div>
           <div><label for="changeDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label> <textarea id="changeDescription" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
           </div>
           <div class="flex gap-3"><button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md font-medium transition-colors"> Simpan Change Part </button> <button type="button" onclick="clearForm('changePartForm')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md font-medium transition-colors"> Reset </button>
           </div>
          </form>
         </div><!-- Change Parts List -->
         <div class="mt-6">
          <div class="flex justify-between items-center mb-4">
           <h4 class="text-lg font-semibold text-gray-800">Riwayat Change Part</h4>
           <div class="flex gap-2"><button onclick="exportToExcel('changeParts')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"> Export Excel </button> <input type="file" id="importChangePartsFile" accept=".xlsx,.xls,.csv" class="hidden" onchange="importFromExcel('changeParts')"> <button onclick="document.getElementById('importChangePartsFile').click()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"> Import Excel </button> <button onclick="showImportTemplate('changeParts')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"> Template Import </button>
           </div>
          </div>
          <div id="changePartsList" class="bg-white border rounded-lg overflow-hidden">
           <div class="text-center py-8 text-gray-500">
            Belum ada data change part
           </div>
          </div>
         </div>
        </div>
        <div id="tab-analytics" class="tab-content hidden">
         <div class="space-y-8"><!-- Header Section -->
          <div class="text-center">
           <div class="inline-flex items-center gap-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-full mb-4">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <h3 class="text-xl font-bold">Dashboard Analitik</h3>
           </div>
           <p class="text-gray-600 text-lg" id="analytics-machine-name">Analisa mendalam untuk semua data mesin</p>
          </div><!-- Enhanced Summary Cards with Animations -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
           <div class="group relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105">
            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10"></div>
            <div class="absolute bottom-0 left-0 w-16 h-16 bg-white/5 rounded-full -ml-8 -mb-8"></div>
            <div class="relative z-10">
             <div class="flex items-center justify-between mb-4">
              <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
               <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
               </svg>
              </div>
              <div class="text-right">
               <div class="text-blue-100 text-sm font-medium">
                Total Parts
               </div>
               <div id="totalParts" class="text-3xl font-bold group-hover:scale-110 transition-transform duration-300">
                0
               </div>
              </div>
             </div>
             <div class="flex items-center text-blue-100 text-sm">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg><span>Komponen aktif</span>
             </div>
            </div>
           </div>
           <div class="group relative overflow-hidden bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105">
            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10"></div>
            <div class="absolute bottom-0 left-0 w-16 h-16 bg-white/5 rounded-full -ml-8 -mb-8"></div>
            <div class="relative z-10">
             <div class="flex items-center justify-between mb-4">
              <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
               <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
               </svg>
              </div>
              <div class="text-right">
               <div class="text-emerald-100 text-sm font-medium">
                Total Stok
               </div>
               <div id="totalStock" class="text-3xl font-bold group-hover:scale-110 transition-transform duration-300">
                0
               </div>
              </div>
             </div>
             <div class="flex items-center text-emerald-100 text-sm">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg><span>Unit tersedia</span>
             </div>
            </div>
           </div>
           <div class="group relative overflow-hidden bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105">
            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10"></div>
            <div class="absolute bottom-0 left-0 w-16 h-16 bg-white/5 rounded-full -ml-8 -mb-8"></div>
            <div class="relative z-10">
             <div class="flex items-center justify-between mb-4">
              <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
               <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
               </svg>
              </div>
              <div class="text-right">
               <div class="text-purple-100 text-sm font-medium">
                Change Parts
               </div>
               <div id="totalChangeParts" class="text-3xl font-bold group-hover:scale-110 transition-transform duration-300">
                0
               </div>
              </div>
             </div>
             <div class="flex items-center text-purple-100 text-sm">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
              </svg><span>Penggantian</span>
             </div>
            </div>
           </div>
           <div class="group relative overflow-hidden bg-gradient-to-br from-amber-500 to-amber-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105">
            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10"></div>
            <div class="absolute bottom-0 left-0 w-16 h-16 bg-white/5 rounded-full -ml-8 -mb-8"></div>
            <div class="relative z-10">
             <div class="flex items-center justify-between mb-4">
              <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
               <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
               </svg>
              </div>
              <div class="text-right">
               <div class="text-amber-100 text-sm font-medium">
                Vendors
               </div>
               <div id="totalVendors" class="text-3xl font-bold group-hover:scale-110 transition-transform duration-300">
                0
               </div>
              </div>
             </div>
             <div class="flex items-center text-amber-100 text-sm">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg><span>Supplier aktif</span>
             </div>
            </div>
           </div>
          </div><!-- Enhanced Charts Section -->
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-8"><!-- Vendor Distribution Chart -->
           <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-100">
             <div class="flex items-center justify-between">
              <div>
               <h4 class="text-xl font-bold text-gray-800 mb-1">Distribusi Stok per Vendor</h4>
               <p class="text-gray-600 text-sm">Analisa persebaran stok berdasarkan supplier</p>
              </div>
              <div class="p-3 bg-blue-100 rounded-xl">
               <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
               </svg>
              </div>
             </div>
            </div>
            <div class="p-6">
             <div class="relative">
              <canvas id="vendorChart" width="400" height="300" class="max-w-full"></canvas>
              <div id="vendorChartLegend" class="mt-4 flex flex-wrap gap-3 justify-center"></div>
             </div>
            </div>
           </div><!-- Trend Chart -->
           <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-gray-100">
             <div class="flex items-center justify-between">
              <div>
               <h4 class="text-xl font-bold text-gray-800 mb-1">Trend Change Parts</h4>
               <p class="text-gray-600 text-sm">Perkembangan penggantian part per bulan</p>
              </div>
              <div class="p-3 bg-purple-100 rounded-xl">
               <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
               </svg>
              </div>
             </div>
            </div>
            <div class="p-6">
             <div class="relative">
              <canvas id="trendChart" width="400" height="300" class="max-w-full"></canvas>
              <div id="trendChartInfo" class="mt-4 text-center text-sm text-gray-600"></div>
             </div>
            </div>
           </div>
          </div><!-- Stock Status Analysis -->
          <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
           <div class="bg-gradient-to-r from-emerald-50 to-teal-50 px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
             <div>
              <h4 class="text-xl font-bold text-gray-800 mb-1">Analisa Status Stok</h4>
              <p class="text-gray-600 text-sm">Distribusi dan kondisi stok saat ini</p>
             </div>
             <div class="p-3 bg-emerald-100 rounded-xl">
              <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
             </div>
            </div>
           </div>
           <div class="p-6">
            <div id="stockAnalysis" class="grid grid-cols-1 md:grid-cols-3 gap-6"><!-- Stock analysis will be populated by JavaScript -->
            </div>
           </div>
          </div><!-- Enhanced Export Section -->
          <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl p-6 border border-gray-200">
           <div class="flex items-center justify-between">
            <div>
             <h4 class="text-xl font-bold text-gray-800 mb-2">Export Laporan Analitik</h4>
             <p class="text-gray-600">Download laporan lengkap dalam format yang mudah dibaca</p>
            </div>
            <div class="flex gap-3"><button onclick="exportAnalytics()" class="group bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
              <div class="flex items-center gap-3">
               <svg class="w-5 h-5 group-hover:rotate-12 transition-transform duration-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
               </svg><span>Export Laporan</span>
              </div></button> <button onclick="printAnalytics()" class="group bg-white hover:bg-gray-50 text-gray-700 border-2 border-gray-300 hover:border-gray-400 px-8 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
              <div class="flex items-center gap-3">
               <svg class="w-5 h-5 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
               </svg><span>Print</span>
              </div></button>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </section>
   </main>
  </div>
  <script>
        // Supabase Configuration
        const SUPABASE_URL = "https://xwavsdmaozseitrjakiv.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3YXZzZG1hb3pzZWl0cmpha2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMDA3NjksImV4cCI6MjA3NjY3Njc2OX0.NfMZG43Ranv1sjeBzdUDAC0Hx4lD0bmsVGtQBzS0MJA";

        // Initialize Supabase client
        let supabaseClient = null;
        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // Features block configuration
        const featuresConfig = {
            "persistence_enabled": false,
            "app_name": "Final Mixing AI",
            "edit_panel": {
                "header_section": {
                    "type": "label",
                    "text": "Header Content",
                    "size": "large"
                },
                "main_title": {
                    "type": "text_input",
                    "label": "Main Title",
                    "placeholder": "Enter main title"
                },
                "subtitle": {
                    "type": "text_input",
                    "label": "Subtitle",
                    "placeholder": "Enter subtitle"
                },
                "content_section": {
                    "type": "label",
                    "text": "Machine Details",
                    "size": "medium"
                },
                "detail_button_text": {
                    "type": "text_input",
                    "label": "Detail Button Text",
                    "placeholder": "Button text"
                },
                "images_section": {
                    "type": "label",
                    "text": "Machine Images",
                    "size": "medium"
                },
                "smg_image_url": {
                    "type": "text_input",
                    "label": "SMG Yenchen 400 Image URL",
                    "placeholder": "https://example.com/image.jpg"
                },
                "zanchetta_image_url": {
                    "type": "text_input",
                    "label": "Zanchetta Roto F-200 Image URL",
                    "placeholder": "https://example.com/image.jpg"
                },
                "drum_image_url": {
                    "type": "text_input",
                    "label": "Drum Mixer Image URL",
                    "placeholder": "https://example.com/image.jpg"
                },
                "tumbling800_image_url": {
                    "type": "text_input",
                    "label": "Tumbling 800 Image URL",
                    "placeholder": "https://example.com/image.jpg"
                },
                "tumbling1500_image_url": {
                    "type": "text_input",
                    "label": "Tumbling 1500 Image URL",
                    "placeholder": "https://example.com/image.jpg"
                }
            }
        };

        const defaultConfig = {
            main_title: "Final Mixing",
            subtitle: "Mesin Final Mixing Berteknologi AI Modern",
            detail_button_text: "Detail Lengkap",
            background_color: "#667eea",
            surface_color: "#ffffff",
            text_color: "#1f2937",
            primary_action_color: "#3b82f6",
            secondary_action_color: "#6b7280",
            smg_image_url: "https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=228&h=228&fit=crop&crop=center",
            zanchetta_image_url: "https://images.unsplash.com/photo-1565043666747-69f6646db940?w=228&h=228&fit=crop&crop=center",
            drum_image_url: "https://images.unsplash.com/photo-1504328345606-18bbc8c9d7d1?w=228&h=228&fit=crop&crop=center",
            tumbling800_image_url: "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=228&h=228&fit=crop&crop=center",
            tumbling1500_image_url: "https://images.unsplash.com/photo-1587293852726-70cdb56c2866?w=228&h=228&fit=crop&crop=center"
        };

        // Data storage
        let partsData = [];
        let changePartsData = [];
        let isLoading = false;
        let currentRecordCount = 0;

        // Supabase Database Functions
        async function savePartToSupabase(partData) {
            if (!supabaseClient) {
                throw new Error('Supabase client not initialized');
            }

            const { data, error } = await supabaseClient
                .from('part_mesin')
                .insert([{
                    nama_mesin: partData.machineName,
                    nama_part: partData.partName,
                    part_number: partData.partNumber,
                    jumlah: partData.stock,
                    deskripsi: partData.description,
                    vendor: partData.vendor,
                    type: partData.type,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }]);

            if (error) {
                throw new Error(error.message);
            }

            return data;
        }

        async function loadPartsFromSupabase() {
            if (!supabaseClient) {
                return [];
            }

            try {
                const { data, error } = await supabaseClient
                    .from('part_mesin')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading parts from Supabase:', error);
                    return [];
                }

                return data || [];
            } catch (error) {
                console.error('Error loading parts from Supabase:', error);
                return [];
            }
        }

        async function updatePartInSupabase(partData) {
            if (!supabaseClient) {
                throw new Error('Supabase client not initialized');
            }

            const { data, error } = await supabaseClient
                .from('part_mesin')
                .update({
                    nama_mesin: partData.machineName,
                    nama_part: partData.partName,
                    part_number: partData.partNumber,
                    jumlah: partData.stock,
                    deskripsi: partData.description,
                    vendor: partData.vendor,
                    updated_at: new Date().toISOString()
                })
                .eq('id', partData.supabaseId);

            if (error) {
                throw new Error(error.message);
            }

            return data;
        }

        async function deletePartFromSupabase(partId) {
            if (!supabaseClient) {
                throw new Error('Supabase client not initialized');
            }

            const { data, error } = await supabaseClient
                .from('part_mesin')
                .delete()
                .eq('id', partId);

            if (error) {
                throw new Error(error.message);
            }

            return data;
        }

        // Load and update parts data from Supabase
        async function loadAndUpdatePartsData() {
            try {
                const supabaseData = await loadPartsFromSupabase();
                
                // Convert Supabase data to internal format
                const convertedData = supabaseData.map(item => ({
                    id: item.id.toString(),
                    supabaseId: item.id,
                    type: item.type || 'part',
                    machineName: item.nama_mesin,
                    partName: item.nama_part,
                    partNumber: item.part_number,
                    stock: item.jumlah,
                    vendor: item.vendor,
                    description: item.deskripsi,
                    createdAt: item.created_at,
                    updatedAt: item.updated_at
                }));
                
                // Separate parts and change parts
                partsData = convertedData.filter(item => item.type === 'part');
                changePartsData = convertedData.filter(item => item.type === 'changePart');
                currentRecordCount = convertedData.length;
                
                // Update UI
                renderPartsList();
                renderChangePartsList();
                updateHomeStats();
                renderHomePartsList();
                renderHomeChangePartsList();
                
                // Update analytics if tab is active
                const analyticsTab = document.getElementById('tab-analytics');
                if (analyticsTab && !analyticsTab.classList.contains('hidden')) {
                    updateAnalytics();
                }
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
            }
        }

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                currentRecordCount = data.length;
                
                // Separate parts and change parts
                partsData = data.filter(item => item.type === 'part');
                changePartsData = data.filter(item => item.type === 'changePart');
                
                // Update UI
                renderPartsList();
                renderChangePartsList();
                updateHomeStats();
                renderHomePartsList();
                renderHomeChangePartsList();
                
                // Update analytics if tab is active
                const analyticsTab = document.getElementById('tab-analytics');
                if (analyticsTab && !analyticsTab.classList.contains('hidden')) {
                    updateAnalytics();
                }
            }
        };

        // Initialize Data SDK
        async function initializeDataSDK() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error("Failed to initialize data SDK");
                    showMessage('Gagal menginisialisasi database', 'error');
                }
            }
        }

        const machineDetails = {
            smg: {
                title: "SMG Yenchen 400",
                content: `
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Kapasitas:</span>
                            <span>400 Liter</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Tahun Pembuatan:</span>
                            <span>2023</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Negara Pembuat:</span>
                            <span>Taiwan</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Dimensi:</span>
                            <span>2000 x 1500 x 2200 mm</span>
                        </div>
                    </div>
                `
            },
            zanchetta: {
                title: "Zanchetta Roto F-200",
                content: `
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Kapasitas:</span>
                            <span>200 Liter</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Tahun Pembuatan:</span>
                            <span>2022</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Negara Pembuat:</span>
                            <span>Italia</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Dimensi:</span>
                            <span>1800 x 1200 x 1900 mm</span>
                        </div>
                    </div>
                `
            },
            drum: {
                title: "Drum Mixer",
                content: `
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Kapasitas:</span>
                            <span>300 Liter</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Tahun Pembuatan:</span>
                            <span>2021</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Negara Pembuat:</span>
                            <span>Jerman</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Dimensi:</span>
                            <span>2200 x 1400 x 1800 mm</span>
                        </div>
                    </div>
                `
            },
            tumbling800: {
                title: "Tumbling 800",
                content: `
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Kapasitas:</span>
                            <span>800 Liter</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Tahun Pembuatan:</span>
                            <span>2023</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Negara Pembuat:</span>
                            <span>Amerika Serikat</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Dimensi:</span>
                            <span>2800 x 2000 x 2500 mm</span>
                        </div>
                    </div>
                `
            },
            tumbling1500: {
                title: "Tumbling 1500",
                content: `
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Kapasitas:</span>
                            <span>1500 Liter</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Tahun Pembuatan:</span>
                            <span>2024</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Negara Pembuat:</span>
                            <span>Jepang</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">Dimensi:</span>
                            <span>3500 x 2500 x 3000 mm</span>
                        </div>
                    </div>
                `
            }
        };



        function closeDetail() {
            const modal = document.getElementById('detailModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Close modal when clicking outside
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetail();
            }
        });

        // Tab functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update analytics if analytics tab is selected
            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // Initialize first tab when modal opens
        let currentMachine = '';

        function showDetail(machineType) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            
            const machine = machineDetails[machineType];
            title.textContent = machine.title;
            currentMachine = machine.title;
            
            // Auto-fill machine name in both forms
            document.getElementById('machineName').value = machine.title;
            document.getElementById('changePartMachine').value = machine.title;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Show first tab (add-part) by default
            switchTab('add-part');
            
            // Render filtered data for this machine
            renderPartsList();
            renderChangePartsList();
        }

        // Form handling
        document.getElementById('addPartForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            // Check record limit
            if (currentRecordCount >= 999) {
                showMessage('Maksimum 999 data telah tercapai. Hapus beberapa data terlebih dahulu.', 'error');
                return;
            }
            
            isLoading = true;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Menyimpan...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(e.target);
                const partData = {
                    type: 'part',
                    machineName: formData.get('machineName'),
                    partName: formData.get('partName'),
                    partNumber: formData.get('partNumber'),
                    stock: parseInt(formData.get('stock')),
                    vendor: formData.get('vendor'),
                    description: formData.get('description'),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Check if in edit mode
                const isEditMode = e.target.dataset.editMode === 'true';
                const editId = e.target.dataset.editId;
                
                // Try Supabase first, then fallback to Data SDK or local storage
                try {
                    if (isEditMode && editId) {
                        // Update existing part in Supabase
                        const existingPart = partsData.find(p => (p.supabaseId || p.__backendId || p.id) === editId);
                        if (existingPart && existingPart.supabaseId) {
                            partData.supabaseId = existingPart.supabaseId;
                            await updatePartInSupabase(partData);
                            cancelEditPart();
                            showMessage('✅ Part berhasil diupdate di database!', 'success');
                            await loadAndUpdatePartsData();
                        }
                    } else {
                        // Create new part in Supabase
                        await savePartToSupabase(partData);
                        clearForm('addPartForm');
                        showMessage('✅ Part berhasil disimpan ke database!', 'success');
                        await loadAndUpdatePartsData();
                    }
                } catch (supabaseError) {
                    console.warn('Supabase error, falling back to Data SDK:', supabaseError);
                    
                    // Fallback to Data SDK
                    if (window.dataSdk) {
                        if (isEditMode && editId) {
                            // Update existing part
                            const existingPart = partsData.find(p => (p.__backendId || p.id) === editId);
                            if (existingPart) {
                                const updatedPart = { ...existingPart, ...partData, updatedAt: new Date().toISOString() };
                                const result = await window.dataSdk.update(updatedPart);
                                if (result.isOk) {
                                    cancelEditPart();
                                    showMessage('Part berhasil diupdate!', 'success');
                                } else {
                                    showMessage('Gagal mengupdate part: ' + result.error.message, 'error');
                                }
                            }
                        } else {
                            // Create new part
                            const result = await window.dataSdk.create(partData);
                            if (result.isOk) {
                                clearForm('addPartForm');
                                showMessage('Part berhasil ditambahkan!', 'success');
                            } else {
                                showMessage('Gagal menyimpan part: ' + result.error.message, 'error');
                            }
                        }
                    } else {
                        // Final fallback for local storage
                        if (isEditMode && editId) {
                            const index = partsData.findIndex(p => (p.__backendId || p.id) === editId);
                            if (index !== -1) {
                                partsData[index] = { ...partsData[index], ...partData, updatedAt: new Date().toISOString() };
                                renderPartsList();
                                cancelEditPart();
                                showMessage('Part berhasil diupdate!', 'success');
                            }
                        } else {
                            partData.id = Date.now().toString();
                            partsData.push(partData);
                            renderPartsList();
                            clearForm('addPartForm');
                            showMessage('Part berhasil ditambahkan!', 'success');
                        }
                    }
                }
            } catch (error) {
                showMessage('❌ Terjadi kesalahan: ' + error.message, 'error');
            } finally {
                isLoading = false;
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        document.getElementById('changePartForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            // Check record limit
            if (currentRecordCount >= 999) {
                showMessage('Maksimum 999 data telah tercapai. Hapus beberapa data terlebih dahulu.', 'error');
                return;
            }
            
            isLoading = true;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Menyimpan...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(e.target);
                const changePartData = {
                    type: 'changePart',
                    machineName: formData.get('machineName'),
                    partName: formData.get('partName'),
                    partNumber: formData.get('partNumber'),
                    stock: parseInt(formData.get('stock')),
                    vendor: formData.get('vendor'),
                    description: formData.get('description'),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Check if in edit mode
                const isEditMode = e.target.dataset.editMode === 'true';
                const editId = e.target.dataset.editId;
                
                if (window.dataSdk) {
                    if (isEditMode && editId) {
                        // Update existing change part
                        const existingPart = changePartsData.find(p => (p.__backendId || p.id) === editId);
                        if (existingPart) {
                            const updatedPart = { ...existingPart, ...changePartData, updatedAt: new Date().toISOString() };
                            const result = await window.dataSdk.update(updatedPart);
                            if (result.isOk) {
                                cancelEditChangePart();
                                showMessage('Change part berhasil diupdate!', 'success');
                            } else {
                                showMessage('Gagal mengupdate change part: ' + result.error.message, 'error');
                            }
                        }
                    } else {
                        // Create new change part
                        const result = await window.dataSdk.create(changePartData);
                        if (result.isOk) {
                            clearForm('changePartForm');
                            showMessage('Change part berhasil ditambahkan!', 'success');
                        } else {
                            showMessage('Gagal menyimpan change part: ' + result.error.message, 'error');
                        }
                    }
                } else {
                    // Fallback for local storage
                    if (isEditMode && editId) {
                        const index = changePartsData.findIndex(p => (p.__backendId || p.id) === editId);
                        if (index !== -1) {
                            changePartsData[index] = { ...changePartsData[index], ...changePartData, updatedAt: new Date().toISOString() };
                            renderChangePartsList();
                            cancelEditChangePart();
                            showMessage('Change part berhasil diupdate!', 'success');
                        }
                    } else {
                        changePartData.id = Date.now().toString();
                        changePartsData.push(changePartData);
                        renderChangePartsList();
                        clearForm('changePartForm');
                        showMessage('Change part berhasil ditambahkan!', 'success');
                    }
                }
            } catch (error) {
                showMessage('Terjadi kesalahan: ' + error.message, 'error');
            } finally {
                isLoading = false;
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        function clearForm(formId) {
            document.getElementById(formId).reset();
        }

        function showMessage(message, type = 'info') {
            // Create toast message
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function renderPartsList() {
            const container = document.getElementById('partsList');
            
            // Use currentMachine variable instead of modal title
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            
            // Filter parts by current machine
            const currentMachineParts = partsData.filter(part => part.machineName === machineName);
            
            if (currentMachineParts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Data Part untuk ${machineName}</h3>
                        <p class="text-gray-500">Mulai tambahkan part mesin untuk melihat daftar di sini</p>
                    </div>
                `;
                return;
            }
            
            // Create table-based layout (horizontal rows) - use filtered data
            const tableRows = currentMachineParts.map(part => {
                const stockStatus = part.stock <= 5 ? 'low' : part.stock <= 15 ? 'medium' : 'high';
                const stockColor = stockStatus === 'low' ? 'text-red-600 bg-red-50' : 
                                 stockStatus === 'medium' ? 'text-yellow-600 bg-yellow-50' : 
                                 'text-green-600 bg-green-50';
                
                const stockIcon = stockStatus === 'low' ? 
                    '<svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' :
                    stockStatus === 'medium' ? 
                    '<svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>' :
                    '<svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>';
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${part.machineName}</div>
                                    <div class="text-sm text-gray-500">Mesin</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${part.partName}</div>
                            <div class="text-sm text-gray-500">${part.partNumber}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                ${stockIcon}
                                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${stockColor}">
                                    ${part.stock} unit
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${part.vendor}</div>
                            <div class="text-sm text-gray-500">Supplier</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 max-w-xs truncate" title="${part.description}">
                                ${part.description}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div>${new Date(part.createdAt).toLocaleDateString('id-ID')}</div>
                            ${part.updatedAt !== part.createdAt ? 
                                `<div class="text-xs text-blue-600">Updated: ${new Date(part.updatedAt).toLocaleDateString('id-ID')}</div>` : 
                                ''
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <button onclick="editPart('${part.__backendId || part.id}')" 
                                        class="text-blue-600 hover:text-blue-900 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="deletePart('${part.__backendId || part.id}')" 
                                        class="text-red-600 hover:text-red-900 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-blue-100">Total Parts</p>
                                    <p class="text-2xl font-bold">${currentMachineParts.length}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-green-100">Total Stok</p>
                                    <p class="text-2xl font-bold">${currentMachineParts.reduce((sum, part) => sum + part.stock, 0)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg p-4 text-white">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-yellow-100">Stok Rendah</p>
                                    <p class="text-2xl font-bold">${currentMachineParts.filter(p => p.stock <= 5).length}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-purple-100">Vendors</p>
                                    <p class="text-2xl font-bold">${new Set(currentMachineParts.map(p => p.vendor)).size}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parts Table -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Mesin
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Part & Number
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Stok
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Vendor
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Deskripsi
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Tanggal
                                        </th>
                                        <th scope="col" class="relative px-6 py-3">
                                            <span class="sr-only">Aksi</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChangePartsList() {
            const container = document.getElementById('changePartsList');
            
            // Use currentMachine variable instead of modal title
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            
            // Filter change parts by current machine
            const currentMachineChangeParts = changePartsData.filter(part => part.machineName === machineName);
            
            if (currentMachineChangeParts.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500">Belum ada data change part untuk ${machineName}</div>`;
                return;
            }
            
            const table = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mesin</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Part</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Part Number</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${currentMachineChangeParts.map(part => `
                            <tr>
                                <td class="px-4 py-3 text-sm text-gray-900">${part.machineName}</td>
                                <td class="px-4 py-3 text-sm text-gray-900">${part.partName}</td>
                                <td class="px-4 py-3 text-sm text-gray-900">${part.partNumber}</td>
                                <td class="px-4 py-3 text-sm text-gray-900">${part.vendor}</td>
                                <td class="px-4 py-3 text-sm">
                                    <div class="flex gap-2">
                                        <button onclick="editChangePart('${part.__backendId || part.id}')" class="text-blue-600 hover:text-blue-800 font-medium">
                                            Edit
                                        </button>
                                        <button onclick="deleteChangePart('${part.__backendId || part.id}')" class="text-red-600 hover:text-red-800 font-medium">
                                            Hapus
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // Edit Part Function
        function editPart(id) {
            const part = partsData.find(p => (p.__backendId || p.id) === id);
            if (!part) return;
            
            // Fill form with existing data
            document.getElementById('machineName').value = part.machineName;
            document.getElementById('partName').value = part.partName;
            document.getElementById('partNumber').value = part.partNumber;
            document.getElementById('stock').value = part.stock;
            document.getElementById('vendor').value = part.vendor;
            document.getElementById('description').value = part.description;
            
            // Change form to edit mode
            const form = document.getElementById('addPartForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Part';
            submitBtn.className = 'bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md font-medium transition-colors';
            
            // Store edit ID
            form.dataset.editId = id;
            form.dataset.editMode = 'true';
            
            // Add cancel button
            if (!form.querySelector('.cancel-edit-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.textContent = 'Batal Edit';
                cancelBtn.className = 'cancel-edit-btn bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md font-medium transition-colors';
                cancelBtn.onclick = cancelEditPart;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
            }
        }

        // Edit Change Part Function
        function editChangePart(id) {
            const part = changePartsData.find(p => (p.__backendId || p.id) === id);
            if (!part) return;
            
            // Fill form with existing data
            document.getElementById('changePartMachine').value = part.machineName;
            document.getElementById('changePartName').value = part.partName;
            document.getElementById('changePartNumber').value = part.partNumber;
            document.getElementById('changeStock').value = part.stock;
            document.getElementById('changeVendor').value = part.vendor;
            document.getElementById('changeDescription').value = part.description;
            
            // Change form to edit mode
            const form = document.getElementById('changePartForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Change Part';
            submitBtn.className = 'bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md font-medium transition-colors';
            
            // Store edit ID
            form.dataset.editId = id;
            form.dataset.editMode = 'true';
            
            // Add cancel button
            if (!form.querySelector('.cancel-edit-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.textContent = 'Batal Edit';
                cancelBtn.className = 'cancel-edit-btn bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md font-medium transition-colors';
                cancelBtn.onclick = cancelEditChangePart;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
            }
        }

        // Cancel Edit Functions
        function cancelEditPart() {
            const form = document.getElementById('addPartForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            const cancelBtn = form.querySelector('.cancel-edit-btn');
            
            // Reset form
            form.reset();
            delete form.dataset.editId;
            delete form.dataset.editMode;
            
            // Reset button
            submitBtn.textContent = 'Simpan Part';
            submitBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium transition-colors';
            
            // Remove cancel button
            if (cancelBtn) cancelBtn.remove();
        }

        function cancelEditChangePart() {
            const form = document.getElementById('changePartForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            const cancelBtn = form.querySelector('.cancel-edit-btn');
            
            // Reset form
            form.reset();
            delete form.dataset.editId;
            delete form.dataset.editMode;
            
            // Reset button
            submitBtn.textContent = 'Simpan Change Part';
            submitBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md font-medium transition-colors';
            
            // Remove cancel button
            if (cancelBtn) cancelBtn.remove();
        }

        // Delete Functions with inline confirmation
        function deletePart(id) {
            const part = partsData.find(p => (p.__backendId || p.id) === id);
            if (!part) return;
            
            // Create inline confirmation
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus part "${part.partName}"?</p>
                    <div class="flex gap-3 justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md">Batal</button>
                        <button onclick="confirmDeletePart('${id}', this)" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">Hapus</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        async function confirmDeletePart(id, button) {
            const confirmDiv = button.closest('.fixed');
            const part = partsData.find(p => (p.supabaseId || p.__backendId || p.id) === id);
            
            if (!part) {
                confirmDiv.remove();
                return;
            }
            
            button.textContent = 'Menghapus...';
            button.disabled = true;
            
            try {
                // Try Supabase first
                if (part.supabaseId) {
                    await deletePartFromSupabase(part.supabaseId);
                    showMessage('✅ Part berhasil dihapus dari database!', 'success');
                    await loadAndUpdatePartsData();
                } else if (window.dataSdk && part.__backendId) {
                    const result = await window.dataSdk.delete(part);
                    if (result.isOk) {
                        showMessage('Part berhasil dihapus!', 'success');
                    } else {
                        showMessage('Gagal menghapus part: ' + result.error.message, 'error');
                    }
                } else {
                    // Fallback for local storage
                    partsData = partsData.filter(p => (p.__backendId || p.id) !== id);
                    renderPartsList();
                    showMessage('Part berhasil dihapus!', 'success');
                }
            } catch (error) {
                showMessage('❌ Terjadi kesalahan: ' + error.message, 'error');
            } finally {
                confirmDiv.remove();
            }
        }

        function deleteChangePart(id) {
            const part = changePartsData.find(p => (p.__backendId || p.id) === id);
            if (!part) return;
            
            // Create inline confirmation
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus change part "${part.partName}"?</p>
                    <div class="flex gap-3 justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md">Batal</button>
                        <button onclick="confirmDeleteChangePart('${id}', this)" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">Hapus</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        async function confirmDeleteChangePart(id, button) {
            const confirmDiv = button.closest('.fixed');
            const part = changePartsData.find(p => (p.__backendId || p.id) === id);
            
            if (!part) {
                confirmDiv.remove();
                return;
            }
            
            button.textContent = 'Menghapus...';
            button.disabled = true;
            
            try {
                if (window.dataSdk && part.__backendId) {
                    const result = await window.dataSdk.delete(part);
                    if (result.isOk) {
                        showMessage('Change part berhasil dihapus!', 'success');
                    } else {
                        showMessage('Gagal menghapus change part: ' + result.error.message, 'error');
                    }
                } else {
                    // Fallback for local storage
                    changePartsData = changePartsData.filter(p => (p.__backendId || p.id) !== id);
                    renderChangePartsList();
                    showMessage('Change part berhasil dihapus!', 'success');
                }
            } catch (error) {
                showMessage('Terjadi kesalahan: ' + error.message, 'error');
            } finally {
                confirmDiv.remove();
            }
        }

        // Enhanced Analytics
        function updateAnalytics() {
            // Use currentMachine variable for filtering
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            
            // Update analytics header
            document.getElementById('analytics-machine-name').textContent = 
                `Analisa mendalam untuk ${machineName}`;
            
            // Filter data by current machine
            const currentMachineParts = partsData.filter(part => part.machineName === machineName);
            const currentMachineChangeParts = changePartsData.filter(part => part.machineName === machineName);
            
            // Update summary cards with filtered data
            document.getElementById('totalParts').textContent = currentMachineParts.length;
            document.getElementById('totalStock').textContent = currentMachineParts.reduce((sum, part) => sum + part.stock, 0);
            document.getElementById('totalChangeParts').textContent = currentMachineChangeParts.length;
            
            const uniqueVendors = new Set([...currentMachineParts.map(p => p.vendor), ...currentMachineChangeParts.map(p => p.vendor)]);
            document.getElementById('totalVendors').textContent = uniqueVendors.size;
            
            // Update charts with filtered data
            updateVendorChart();
            updateTrendChart();
            updateStockAnalysis();
        }

        function updateVendorChart() {
            const canvas = document.getElementById('vendorChart');
            const ctx = canvas.getContext('2d');
            const legendContainer = document.getElementById('vendorChartLegend');
            
            // Clear canvas and legend
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            legendContainer.innerHTML = '';
            
            // Use currentMachine variable for filtering
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            const currentMachineParts = partsData.filter(part => part.machineName === machineName);
            
            // Calculate vendor distribution for current machine only
            const vendorStats = {};
            currentMachineParts.forEach(part => {
                vendorStats[part.vendor] = (vendorStats[part.vendor] || 0) + part.stock;
            });
            
            const vendors = Object.keys(vendorStats);
            const stocks = Object.values(vendorStats);
            
            if (vendors.length === 0) {
                // Enhanced empty state
                ctx.fillStyle = '#e5e7eb';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#9ca3af';
                ctx.font = 'bold 18px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('📊', canvas.width / 2, canvas.height / 2 - 20);
                
                ctx.font = '16px sans-serif';
                ctx.fillText('Belum ada data vendor', canvas.width / 2, canvas.height / 2 + 10);
                
                ctx.font = '12px sans-serif';
                ctx.fillStyle = '#6b7280';
                ctx.fillText('Tambahkan part untuk melihat distribusi', canvas.width / 2, canvas.height / 2 + 30);
                return;
            }
            
            // Enhanced 3D bar chart with gradients
            const maxStock = Math.max(...stocks);
            const totalStock = stocks.reduce((sum, stock) => sum + stock, 0);
            const chartHeight = canvas.height - 80;
            const chartWidth = canvas.width - 40;
            const barWidth = Math.min(chartWidth / vendors.length * 0.7, 80);
            const barSpacing = (chartWidth - (barWidth * vendors.length)) / (vendors.length + 1);
            
            // Color palette
            const colors = [
                { main: '#3b82f6', light: '#60a5fa', dark: '#1d4ed8' },
                { main: '#10b981', light: '#34d399', dark: '#047857' },
                { main: '#f59e0b', light: '#fbbf24', dark: '#d97706' },
                { main: '#ef4444', light: '#f87171', dark: '#dc2626' },
                { main: '#8b5cf6', light: '#a78bfa', dark: '#7c3aed' },
                { main: '#06b6d4', light: '#22d3ee', dark: '#0891b2' },
                { main: '#f97316', light: '#fb923c', dark: '#ea580c' },
                { main: '#84cc16', light: '#a3e635', dark: '#65a30d' }
            ];
            
            vendors.forEach((vendor, index) => {
                const barHeight = (stocks[index] / maxStock) * chartHeight;
                const x = 20 + barSpacing + index * (barWidth + barSpacing);
                const y = canvas.height - barHeight - 50;
                const percentage = ((stocks[index] / totalStock) * 100).toFixed(1);
                
                const color = colors[index % colors.length];
                
                // Create gradient for 3D effect
                const gradient = ctx.createLinearGradient(x, y, x + barWidth, y + barHeight);
                gradient.addColorStop(0, color.light);
                gradient.addColorStop(0.5, color.main);
                gradient.addColorStop(1, color.dark);
                
                // Draw 3D bar with shadow
                ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 3;
                ctx.shadowOffsetY = 3;
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Reset shadow
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                
                // Add highlight on top
                const highlightGradient = ctx.createLinearGradient(x, y, x, y + 20);
                highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                ctx.fillStyle = highlightGradient;
                ctx.fillRect(x, y, barWidth, Math.min(20, barHeight));
                
                // Draw value on top of bar
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(stocks[index], x + barWidth / 2, y - 8);
                
                // Draw percentage
                ctx.font = '12px sans-serif';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(`${percentage}%`, x + barWidth / 2, y - 25);
                
                // Draw vendor name (rotated if too long)
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - 15);
                
                const vendorName = vendor.length > 12 ? vendor.substring(0, 12) + '...' : vendor;
                ctx.fillStyle = '#374151';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                
                if (vendor.length > 8) {
                    ctx.rotate(-Math.PI / 6); // Rotate 30 degrees
                }
                
                ctx.fillText(vendorName, 0, 0);
                ctx.restore();
                
                // Create legend item
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg';
                legendItem.innerHTML = `
                    <div class="w-4 h-4 rounded" style="background: ${color.main}"></div>
                    <div class="text-sm">
                        <div class="font-medium text-gray-800">${vendor}</div>
                        <div class="text-gray-600">${stocks[index]} unit (${percentage}%)</div>
                    </div>
                `;
                legendContainer.appendChild(legendItem);
            });
            
            // Draw grid lines
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = canvas.height - 50 - (i * chartHeight / 5);
                ctx.beginPath();
                ctx.moveTo(20, y);
                ctx.lineTo(canvas.width - 20, y);
                ctx.stroke();
                
                // Y-axis labels
                const value = Math.round((maxStock / 5) * i);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(value.toString(), 15, y + 3);
            }
        }

        function updateTrendChart() {
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            const infoContainer = document.getElementById('trendChartInfo');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Use currentMachine variable for filtering
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            const currentMachineChangeParts = changePartsData.filter(part => part.machineName === machineName);
            
            // Calculate monthly trend for current machine only
            const monthlyData = {};
            currentMachineChangeParts.forEach(part => {
                const month = new Date(part.createdAt).toISOString().substring(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const months = Object.keys(monthlyData).sort();
            const counts = months.map(month => monthlyData[month]);
            
            if (months.length === 0) {
                // Enhanced empty state
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#9ca3af';
                ctx.font = 'bold 18px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('📈', canvas.width / 2, canvas.height / 2 - 20);
                
                ctx.font = '16px sans-serif';
                ctx.fillText('Belum ada data trend', canvas.width / 2, canvas.height / 2 + 10);
                
                ctx.font = '12px sans-serif';
                ctx.fillStyle = '#6b7280';
                ctx.fillText('Tambahkan change part untuk melihat trend', canvas.width / 2, canvas.height / 2 + 30);
                
                infoContainer.textContent = 'Belum ada aktivitas change part yang tercatat';
                return;
            }
            
            // Enhanced line chart with area fill and animations
            const maxCount = Math.max(...counts);
            const minCount = Math.min(...counts);
            const chartHeight = canvas.height - 80;
            const chartWidth = canvas.width - 60;
            const stepX = chartWidth / (months.length - 1 || 1);
            
            // Draw background grid
            ctx.strokeStyle = '#f3f4f6';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = 40 + (i * chartHeight / 5);
                ctx.beginPath();
                ctx.moveTo(30, y);
                ctx.lineTo(canvas.width - 30, y);
                ctx.stroke();
                
                // Y-axis labels
                const value = Math.round(maxCount - (maxCount / 5) * i);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(value.toString(), 25, y + 3);
            }
            
            // Create gradient for area fill
            const areaGradient = ctx.createLinearGradient(0, 40, 0, 40 + chartHeight);
            areaGradient.addColorStop(0, 'rgba(139, 92, 246, 0.3)');
            areaGradient.addColorStop(1, 'rgba(139, 92, 246, 0.05)');
            
            // Draw area fill
            ctx.beginPath();
            ctx.moveTo(30, 40 + chartHeight);
            
            months.forEach((month, index) => {
                const x = 30 + index * stepX;
                const y = 40 + chartHeight - (counts[index] / maxCount) * chartHeight;
                
                if (index === 0) {
                    ctx.lineTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.lineTo(30 + (months.length - 1) * stepX, 40 + chartHeight);
            ctx.closePath();
            ctx.fillStyle = areaGradient;
            ctx.fill();
            
            // Draw main line with gradient
            const lineGradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            lineGradient.addColorStop(0, '#8b5cf6');
            lineGradient.addColorStop(0.5, '#a855f7');
            lineGradient.addColorStop(1, '#c084fc');
            
            ctx.strokeStyle = lineGradient;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            
            months.forEach((month, index) => {
                const x = 30 + index * stepX;
                const y = 40 + chartHeight - (counts[index] / maxCount) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw enhanced data points
            months.forEach((month, index) => {
                const x = 30 + index * stepX;
                const y = 40 + chartHeight - (counts[index] / maxCount) * chartHeight;
                
                // Outer glow
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(139, 92, 246, 0.2)';
                ctx.fill();
                
                // Main point
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = '#8b5cf6';
                ctx.fill();
                
                // Inner highlight
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fillStyle = '#c084fc';
                ctx.fill();
                
                // Value label on hover area
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(counts[index].toString(), x, y - 15);
                
                // Month label
                const monthName = new Date(month + '-01').toLocaleDateString('id-ID', { 
                    month: 'short', 
                    year: '2-digit' 
                });
                ctx.fillStyle = '#6b7280';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                
                // Rotate labels if too many months
                if (months.length > 6) {
                    ctx.save();
                    ctx.translate(x, canvas.height - 15);
                    ctx.rotate(-Math.PI / 4);
                    ctx.fillText(monthName, 0, 0);
                    ctx.restore();
                } else {
                    ctx.fillText(monthName, x, canvas.height - 15);
                }
            });
            
            // Calculate trend statistics
            const totalChanges = counts.reduce((sum, count) => sum + count, 0);
            const avgChanges = (totalChanges / months.length).toFixed(1);
            const trend = months.length > 1 ? 
                (counts[counts.length - 1] > counts[0] ? 'naik' : 
                 counts[counts.length - 1] < counts[0] ? 'turun' : 'stabil') : 'stabil';
            
            const trendIcon = trend === 'naik' ? '📈' : trend === 'turun' ? '📉' : '➡️';
            const trendColor = trend === 'naik' ? 'text-green-600' : trend === 'turun' ? 'text-red-600' : 'text-blue-600';
            
            infoContainer.innerHTML = `
                <div class="flex items-center justify-center gap-4 text-sm">
                    <span class="flex items-center gap-1">
                        <span class="font-medium">Total:</span> 
                        <span class="text-purple-600 font-bold">${totalChanges}</span>
                    </span>
                    <span class="flex items-center gap-1">
                        <span class="font-medium">Rata-rata:</span> 
                        <span class="text-blue-600 font-bold">${avgChanges}/bulan</span>
                    </span>
                    <span class="flex items-center gap-1 ${trendColor}">
                        <span>${trendIcon}</span>
                        <span class="font-medium">Trend ${trend}</span>
                    </span>
                </div>
            `;
        }

        // Template Import functionality
        function showImportTemplate(type) {
            const templateDiv = document.createElement('div');
            templateDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const templateContent = `
                <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">
                            ${type === 'parts' ? 'Template Import Part Mesin' : 'Template Import Change Part'}
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">Format File CSV yang Diperlukan:</h4>
                            <p class="text-blue-700 text-sm">File harus memiliki header dengan kolom berikut (urutan harus sama):</p>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-3">Header CSV (Baris Pertama):</h5>
                            <div class="bg-white p-3 rounded border font-mono text-sm">
                                Nama Mesin,Nama Part,Part Number,Stok,Vendor,Deskripsi
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-3">Contoh Data:</h5>
                            <div class="bg-white p-3 rounded border font-mono text-sm space-y-1">
                                <div>SMG Yenchen 400,Motor Penggerak,MT-001-2023,25,PT Supplier Utama,Motor 3 phase 5HP</div>
                                <div>Zanchetta Roto F-200,Gearbox,GB-002-2023,15,CV Gear Indonesia,Gearbox ratio 1:10</div>
                                <div>Drum Mixer,Sensor Suhu,ST-003-2023,30,PT Sensor Tech,Sensor suhu digital</div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="font-semibold text-yellow-800 mb-2">Catatan Penting:</h4>
                            <ul class="text-yellow-700 text-sm space-y-1">
                                <li>• Header harus persis sama: <strong>Nama Mesin, Nama Part, Part Number, Stok, Vendor, Deskripsi</strong></li>
                                <li>• Kolom Stok harus berisi angka (tidak boleh kosong)</li>
                                <li>• Semua kolom wajib diisi</li>
                                <li>• Format file yang didukung: <strong>.xlsx, .xls, .csv</strong></li>
                                <li>• Untuk Excel: gunakan worksheet pertama, header di baris pertama</li>
                                <li>• Untuk CSV: encoding UTF-8, separator koma</li>
                                <li>• Maksimal 999 data total dalam sistem</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-3 justify-end">
                            <button onclick="downloadTemplate('${type}')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-medium transition-colors">
                                Download Template CSV
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md font-medium transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            templateDiv.innerHTML = templateContent;
            document.body.appendChild(templateDiv);
        }

        function downloadTemplate(type) {
            // Create template data
            const headers = ['Nama Mesin', 'Nama Part', 'Part Number', 'Stok', 'Vendor', 'Deskripsi'];
            let sampleData = [];
            
            if (type === 'parts') {
                sampleData = [
                    ['SMG Yenchen 400', 'Motor Penggerak', 'MT-001-2023', 25, 'PT Supplier Utama', 'Motor 3 phase 5HP'],
                    ['Zanchetta Roto F-200', 'Gearbox', 'GB-002-2023', 15, 'CV Gear Indonesia', 'Gearbox ratio 1:10'],
                    ['Drum Mixer', 'Sensor Suhu', 'ST-003-2023', 30, 'PT Sensor Tech', 'Sensor suhu digital']
                ];
            } else {
                sampleData = [
                    ['Tumbling 800', 'Bearing Utama', 'BR-205-2024', 10, 'CV Bearing Jaya', 'Bearing SKF 6205-2RS'],
                    ['Tumbling 1500', 'Belt Conveyor', 'BC-150-2024', 8, 'PT Belt Industri', 'Belt karet industrial'],
                    ['SMG Yenchen 400', 'Filter Udara', 'FA-400-2024', 20, 'CV Filter Prima', 'Filter udara HEPA']
                ];
            }
            
            // Check if XLSX library is available for Excel template
            if (typeof XLSX !== 'undefined') {
                // Create Excel template
                const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Template');
                
                // Set column widths
                ws['!cols'] = [
                    { width: 20 }, // Nama Mesin
                    { width: 20 }, // Nama Part
                    { width: 15 }, // Part Number
                    { width: 10 }, // Stok
                    { width: 20 }, // Vendor
                    { width: 30 }  // Deskripsi
                ];
                
                // Download Excel file
                const filename = type === 'parts' ? 'template_parts.xlsx' : 'template_change_parts.xlsx';
                XLSX.writeFile(wb, filename);
                
                showMessage('Template Excel berhasil didownload!', 'success');
            } else {
                // Fallback to CSV if XLSX library not available
                let csv = headers.join(',') + '\n';
                csv += sampleData.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = type === 'parts' ? 'template_parts.csv' : 'template_change_parts.csv';
                link.click();
                
                showMessage('Template CSV berhasil didownload!', 'success');
            }
        }

        // Excel Export/Import functionality
        function exportToExcel(type) {
            // Use currentMachine variable for filtering
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            
            // Filter data by current machine
            let data;
            if (type === 'parts') {
                data = partsData.filter(part => part.machineName === machineName);
            } else {
                data = changePartsData.filter(part => part.machineName === machineName);
            }
            
            if (data.length === 0) {
                showMessage(`Tidak ada data ${type === 'parts' ? 'part' : 'change part'} untuk ${machineName}`, 'error');
                return;
            }
            
            // Check if XLSX library is available
            if (typeof XLSX !== 'undefined') {
                // Export as Excel file
                const headers = ['Nama Mesin', 'Nama Part', 'Part Number', 'Stok', 'Vendor', 'Deskripsi', 'Tanggal Dibuat'];
                const exportData = data.map(part => [
                    part.machineName,
                    part.partName,
                    part.partNumber,
                    part.stock,
                    part.vendor,
                    part.description,
                    new Date(part.createdAt).toLocaleDateString('id-ID')
                ]);
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet([headers, ...exportData]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, type === 'parts' ? 'Parts Data' : 'Change Parts Data');
                
                // Set column widths
                ws['!cols'] = [
                    { width: 20 }, // Nama Mesin
                    { width: 20 }, // Nama Part
                    { width: 15 }, // Part Number
                    { width: 10 }, // Stok
                    { width: 20 }, // Vendor
                    { width: 30 }, // Deskripsi
                    { width: 15 }  // Tanggal Dibuat
                ];
                
                // Download Excel file with machine name
                const machineNameForFile = machineName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const filename = type === 'parts' ? 
                    `parts_data_${machineNameForFile}.xlsx` : 
                    `change_parts_data_${machineNameForFile}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showMessage('Data berhasil diekspor ke Excel!', 'success');
            } else {
                // Fallback to CSV export with machine name
                const machineNameForFile = machineName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const filename = type === 'parts' ? 
                    `parts_data_${machineNameForFile}.csv` : 
                    `change_parts_data_${machineNameForFile}.csv`;
                
                let csv = 'Nama Mesin,Nama Part,Part Number,Stok,Vendor,Deskripsi,Tanggal Dibuat\n';
                csv += data.map(part => 
                    `"${part.machineName}","${part.partName}","${part.partNumber}",${part.stock},"${part.vendor}","${part.description}","${new Date(part.createdAt).toLocaleDateString('id-ID')}"`
                ).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                
                showMessage('Data berhasil diekspor ke CSV!', 'success');
            }
        }

        function importFromExcel(type) {
            const fileInput = type === 'parts' ? 
                document.getElementById('importPartsFile') : 
                document.getElementById('importChangePartsFile');
            
            const file = fileInput.files[0];
            if (!file) return;
            
            // Check file type
            const fileName = file.name.toLowerCase();
            const isCSV = fileName.endsWith('.csv');
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            
            if (!isCSV && !isExcel) {
                showMessage('Format file tidak didukung. Gunakan file CSV, XLS, atau XLSX.', 'error');
                fileInput.value = '';
                return;
            }
            
            // Show loading message
            showMessage('Memproses file, mohon tunggu...', 'info');
            
            if (isCSV) {
                // Handle CSV file
                const reader = new FileReader();
                reader.onload = function(e) {
                    processCSVData(e.target.result, type);
                    fileInput.value = '';
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                // Handle Excel file (.xls/.xlsx)
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        processExcelData(e.target.result, type);
                    } catch (error) {
                        showMessage('Error saat membaca file Excel: ' + error.message, 'error');
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Function to process CSV data
        function processCSVData(csvContent, type) {
            try {
                // Validate CSV content
                if (!csvContent || csvContent.trim() === '') {
                    showMessage('File CSV kosong atau tidak valid.', 'error');
                    return;
                }
                
                // Split lines and clean them
                const lines = csvContent.split(/\r?\n/).filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    showMessage('File CSV harus memiliki minimal header dan 1 baris data.', 'error');
                    return;
                }
                
                // Parse header
                const headerLine = lines[0].trim();
                const expectedHeader = 'Nama Mesin,Nama Part,Part Number,Stok,Vendor,Deskripsi';
                
                // Clean header for comparison (remove quotes and extra spaces)
                const cleanHeader = headerLine.replace(/"/g, '').replace(/\s+/g, ' ').trim();
                const cleanExpected = expectedHeader.replace(/\s+/g, ' ').trim();
                
                if (cleanHeader !== cleanExpected) {
                    showMessage(`Header tidak sesuai format. Header yang benar: ${expectedHeader}`, 'error');
                    return;
                }
                
                const importedData = [];
                let errorCount = 0;
                
                // Process data rows
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    try {
                        // Parse CSV line with proper handling of quoted values
                        const values = parseCSVLine(line);
                        
                        if (values.length < 6) {
                            errorCount++;
                            continue;
                        }
                        
                        // Validate and create item
                        const item = validateAndCreateItem(values, type);
                        if (item) {
                            importedData.push(item);
                        } else {
                            errorCount++;
                        }
                    } catch (lineError) {
                        errorCount++;
                        continue;
                    }
                }
                
                if (importedData.length === 0) {
                    showMessage('Tidak ada data valid yang dapat diimpor. Periksa format file CSV.', 'error');
                    return;
                }
                
                // Check record limit and import
                checkLimitAndImport(importedData, type, errorCount);
                
            } catch (error) {
                showMessage('Error saat memproses CSV: ' + error.message, 'error');
            }
        }
        
        // Function to process Excel data using SheetJS
        function processExcelData(arrayBuffer, type) {
            try {
                // Check if XLSX library is loaded
                if (typeof XLSX === 'undefined') {
                    showMessage('Library Excel tidak tersedia. Silakan gunakan file CSV.', 'error');
                    return;
                }
                
                // Read the Excel file using SheetJS
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Get the first worksheet
                const sheetName = workbook.SheetNames[0];
                if (!sheetName) {
                    showMessage('File Excel tidak memiliki worksheet yang valid.', 'error');
                    return;
                }
                
                const worksheet = workbook.Sheets[sheetName];
                
                // Convert worksheet to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1, // Use array of arrays format
                    defval: '', // Default value for empty cells
                    blankrows: false // Skip blank rows
                });
                
                if (jsonData.length < 2) {
                    showMessage('File Excel harus memiliki minimal header dan 1 baris data.', 'error');
                    return;
                }
                
                // Validate header
                const headerRow = jsonData[0];
                const expectedHeaders = ['Nama Mesin', 'Nama Part', 'Part Number', 'Stok', 'Vendor', 'Deskripsi'];
                
                // Check if header matches expected format
                let headerValid = true;
                if (headerRow.length < 6) {
                    headerValid = false;
                } else {
                    for (let i = 0; i < 6; i++) {
                        const actualHeader = String(headerRow[i] || '').trim();
                        const expectedHeader = expectedHeaders[i];
                        if (actualHeader !== expectedHeader) {
                            headerValid = false;
                            break;
                        }
                    }
                }
                
                if (!headerValid) {
                    showMessage(`Header Excel tidak sesuai format. Header yang benar: ${expectedHeaders.join(', ')}`, 'error');
                    return;
                }
                
                const importedData = [];
                let errorCount = 0;
                
                // Process data rows (skip header)
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    if (!row || row.length < 6) {
                        errorCount++;
                        continue;
                    }
                    
                    try {
                        // Convert row to string array and validate
                        const values = row.slice(0, 6).map(cell => String(cell || '').trim());
                        
                        // Validate and create item
                        const item = validateAndCreateItem(values, type);
                        if (item) {
                            importedData.push(item);
                        } else {
                            errorCount++;
                        }
                    } catch (rowError) {
                        errorCount++;
                        continue;
                    }
                }
                
                if (importedData.length === 0) {
                    showMessage('Tidak ada data valid yang dapat diimpor dari file Excel.', 'error');
                    return;
                }
                
                // Check record limit and import
                checkLimitAndImport(importedData, type, errorCount);
                
            } catch (error) {
                showMessage('Error saat memproses file Excel: ' + error.message, 'error');
            }
        }
        
        // Helper function to validate and create item
        function validateAndCreateItem(values, type) {
            if (values.length < 6) return null;
            
            // Validate required fields
            const machineName = values[0]?.trim();
            const partName = values[1]?.trim();
            const partNumber = values[2]?.trim();
            const stockValue = values[3]?.trim();
            const vendor = values[4]?.trim();
            const description = values[5]?.trim();
            
            if (!machineName || !partName || !partNumber || !stockValue || !vendor || !description) {
                return null;
            }
            
            const stock = parseInt(stockValue);
            if (isNaN(stock) || stock < 0) {
                return null;
            }
            
            return {
                type: type === 'parts' ? 'part' : 'changePart',
                machineName: machineName,
                partName: partName,
                partNumber: partNumber,
                stock: stock,
                vendor: vendor,
                description: description,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }
        
        // Helper function to check limit and import
        function checkLimitAndImport(importedData, type, errorCount) {
            // Check record limit
            if (currentRecordCount + importedData.length > 999) {
                showMessage(`Import dibatalkan. Total data akan melebihi batas maksimal 999 record. Saat ini: ${currentRecordCount}, akan ditambah: ${importedData.length}`, 'error');
                return;
            }
            
            // Import data using Data SDK or fallback
            importDataBatch(importedData, type, errorCount);
        }
        
        // Helper function to parse CSV line properly
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add last field
            values.push(current.trim());
            
            return values;
        }
        
        // Helper function to import data in batch
        async function importDataBatch(importedData, type, errorCount) {
            if (window.dataSdk) {
                // Use Data SDK
                let successCount = 0;
                let failCount = 0;
                
                for (const item of importedData) {
                    try {
                        const result = await window.dataSdk.create(item);
                        if (result.isOk) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                let message = `Import selesai: ${successCount} berhasil`;
                if (failCount > 0) message += `, ${failCount} gagal`;
                if (errorCount > 0) message += `, ${errorCount} baris diabaikan (format salah)`;
                
                showMessage(message, successCount > 0 ? 'success' : 'error');
            } else {
                // Fallback to local storage
                if (type === 'parts') {
                    importedData.forEach(item => {
                        item.id = Date.now() + Math.random();
                        partsData.push(item);
                    });
                    renderPartsList();
                } else {
                    importedData.forEach(item => {
                        item.id = Date.now() + Math.random();
                        changePartsData.push(item);
                    });
                    renderChangePartsList();
                }
                
                let message = `${importedData.length} data berhasil diimpor`;
                if (errorCount > 0) message += `, ${errorCount} baris diabaikan (format salah)`;
                
                showMessage(message, 'success');
            }
        }

        // Stock Analysis Function
        function updateStockAnalysis() {
            const container = document.getElementById('stockAnalysis');
            
            // Use currentMachine variable for filtering
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            const currentMachineParts = partsData.filter(part => part.machineName === machineName);
            
            if (currentMachineParts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-12">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Data Stok</h3>
                        <p class="text-gray-500">Tambahkan part untuk melihat analisa stok</p>
                    </div>
                `;
                return;
            }
            
            // Calculate stock statistics
            const lowStockParts = currentMachineParts.filter(p => p.stock <= 5);
            const mediumStockParts = currentMachineParts.filter(p => p.stock > 5 && p.stock <= 15);
            const highStockParts = currentMachineParts.filter(p => p.stock > 15);
            
            const totalParts = currentMachineParts.length;
            const lowPercentage = ((lowStockParts.length / totalParts) * 100).toFixed(1);
            const mediumPercentage = ((mediumStockParts.length / totalParts) * 100).toFixed(1);
            const highPercentage = ((highStockParts.length / totalParts) * 100).toFixed(1);
            
            // Calculate average stock
            const totalStock = currentMachineParts.reduce((sum, part) => sum + part.stock, 0);
            const avgStock = (totalStock / totalParts).toFixed(1);
            
            // Find critical parts (lowest stock)
            const criticalParts = currentMachineParts
                .sort((a, b) => a.stock - b.stock)
                .slice(0, 3);
            
            container.innerHTML = `
                <!-- Low Stock Analysis -->
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-6 border border-red-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-red-500 rounded-xl">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-red-800">Stok Rendah</h4>
                                <p class="text-red-600 text-sm">≤ 5 unit</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-red-800">${lowStockParts.length}</div>
                            <div class="text-red-600 text-sm">${lowPercentage}% dari total</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${lowStockParts.slice(0, 3).map(part => `
                            <div class="flex items-center justify-between bg-white/50 rounded-lg p-2">
                                <span class="text-red-800 font-medium text-sm">${part.partName}</span>
                                <span class="text-red-600 font-bold">${part.stock} unit</span>
                            </div>
                        `).join('')}
                        ${lowStockParts.length > 3 ? `
                            <div class="text-center text-red-600 text-sm font-medium">
                                +${lowStockParts.length - 3} part lainnya
                            </div>
                        ` : ''}
                        ${lowStockParts.length === 0 ? `
                            <div class="text-center text-red-600 text-sm py-2">
                                ✅ Tidak ada stok rendah
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Medium Stock Analysis -->
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-6 border border-yellow-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-yellow-500 rounded-xl">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-yellow-800">Stok Sedang</h4>
                                <p class="text-yellow-600 text-sm">6-15 unit</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-yellow-800">${mediumStockParts.length}</div>
                            <div class="text-yellow-600 text-sm">${mediumPercentage}% dari total</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${mediumStockParts.slice(0, 3).map(part => `
                            <div class="flex items-center justify-between bg-white/50 rounded-lg p-2">
                                <span class="text-yellow-800 font-medium text-sm">${part.partName}</span>
                                <span class="text-yellow-600 font-bold">${part.stock} unit</span>
                            </div>
                        `).join('')}
                        ${mediumStockParts.length > 3 ? `
                            <div class="text-center text-yellow-600 text-sm font-medium">
                                +${mediumStockParts.length - 3} part lainnya
                            </div>
                        ` : ''}
                        ${mediumStockParts.length === 0 ? `
                            <div class="text-center text-yellow-600 text-sm py-2">
                                Tidak ada stok sedang
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- High Stock Analysis -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-green-500 rounded-xl">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-green-800">Stok Tinggi</h4>
                                <p class="text-green-600 text-sm">> 15 unit</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-green-800">${highStockParts.length}</div>
                            <div class="text-green-600 text-sm">${highPercentage}% dari total</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${highStockParts.slice(0, 3).map(part => `
                            <div class="flex items-center justify-between bg-white/50 rounded-lg p-2">
                                <span class="text-green-800 font-medium text-sm">${part.partName}</span>
                                <span class="text-green-600 font-bold">${part.stock} unit</span>
                            </div>
                        `).join('')}
                        ${highStockParts.length > 3 ? `
                            <div class="text-center text-green-600 text-sm font-medium">
                                +${highStockParts.length - 3} part lainnya
                            </div>
                        ` : ''}
                        ${highStockParts.length === 0 ? `
                            <div class="text-center text-green-600 text-sm py-2">
                                Tidak ada stok tinggi
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Print Analytics Function
        function printAnalytics() {
            const printWindow = window.open('', '_blank');
            const machineName = currentMachine || document.getElementById('modalTitle').textContent;
            const currentDate = new Date().toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const currentMachineParts = partsData.filter(part => part.machineName === machineName);
            const currentMachineChangeParts = changePartsData.filter(part => part.machineName === machineName);
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Laporan Analitik - ${machineName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .summary-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
                        .summary-card h3 { margin: 0 0 10px 0; color: #333; }
                        .summary-card .value { font-size: 24px; font-weight: bold; color: #0066cc; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Laporan Analitik Mesin</h1>
                        <h2>${machineName}</h2>
                        <p>Tanggal: ${currentDate}</p>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-card">
                            <h3>Total Parts</h3>
                            <div class="value">${currentMachineParts.length}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Stok</h3>
                            <div class="value">${currentMachineParts.reduce((sum, part) => sum + part.stock, 0)}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Change Parts</h3>
                            <div class="value">${currentMachineChangeParts.length}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Vendors</h3>
                            <div class="value">${new Set([...currentMachineParts.map(p => p.vendor), ...currentMachineChangeParts.map(p => p.vendor)]).size}</div>
                        </div>
                    </div>
                    
                    <h3>Daftar Parts</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Nama Part</th>
                                <th>Part Number</th>
                                <th>Stok</th>
                                <th>Vendor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentMachineParts.map(part => `
                                <tr>
                                    <td>${part.partName}</td>
                                    <td>${part.partNumber}</td>
                                    <td>${part.stock}</td>
                                    <td>${part.vendor}</td>
                                    <td>${part.stock <= 5 ? 'Rendah' : part.stock <= 15 ? 'Sedang' : 'Tinggi'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Laporan ini dibuat secara otomatis oleh sistem Final Mixing AI</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function exportAnalytics() {
            const analyticsData = {
                summary: {
                    totalParts: partsData.length,
                    totalStock: partsData.reduce((sum, part) => sum + part.stock, 0),
                    totalChangeParts: changePartsData.length,
                    totalVendors: new Set([...partsData.map(p => p.vendor), ...changePartsData.map(p => p.vendor)]).size
                },
                parts: partsData,
                changeParts: changePartsData
            };
            
            const blob = new Blob([JSON.stringify(analyticsData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'analytics_report.json';
            link.click();
            
            showMessage('Laporan analitik berhasil diekspor!', 'success');
        }

        // Element SDK Implementation
        async function render(config) {
            document.getElementById('main-title').textContent = config.main_title || defaultConfig.main_title;
            document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
            
            // Update all detail buttons
            const buttons = document.querySelectorAll('[id^="detail-btn-"]');
            buttons.forEach(button => {
                button.textContent = config.detail_button_text || defaultConfig.detail_button_text;
            });

            // Update machine images
            updateMachineImage('smg', config.smg_image_url);
            updateMachineImage('zanchetta', config.zanchetta_image_url);
            updateMachineImage('drum', config.drum_image_url);
            updateMachineImage('tumbling800', config.tumbling800_image_url);
            updateMachineImage('tumbling1500', config.tumbling1500_image_url);

            // Apply colors
            const bgColor = config.background_color || defaultConfig.background_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
            
            document.body.style.background = `linear-gradient(135deg, ${bgColor} 0%, #764ba2 100%)`;
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle) modalTitle.style.color = textColor;

            // Apply font family
            const fontFamily = config.font_family || defaultConfig.font_family;
            if (fontFamily) {
                document.body.style.fontFamily = `${fontFamily}, sans-serif`;
            }

            // Apply font size scaling
            const fontSize = config.font_size || 16;
            document.getElementById('main-title').style.fontSize = `${fontSize * 3.125}px`; // 5xl equivalent
            document.getElementById('subtitle').style.fontSize = `${fontSize * 1.25}px`; // xl equivalent
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.background_color || defaultConfig.background_color,
                        set: (value) => {
                            config.background_color = value;
                            window.elementSdk.setConfig({ background_color: value });
                        }
                    },
                    {
                        get: () => config.text_color || defaultConfig.text_color,
                        set: (value) => {
                            config.text_color = value;
                            window.elementSdk.setConfig({ text_color: value });
                        }
                    },
                    {
                        get: () => config.primary_action_color || defaultConfig.primary_action_color,
                        set: (value) => {
                            config.primary_action_color = value;
                            window.elementSdk.setConfig({ primary_action_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: {
                    get: () => config.font_family || defaultConfig.font_family,
                    set: (value) => {
                        config.font_family = value;
                        window.elementSdk.setConfig({ font_family: value });
                    }
                },
                fontSizeable: {
                    get: () => config.font_size || 16,
                    set: (value) => {
                        config.font_size = value;
                        window.elementSdk.setConfig({ font_size: value });
                    }
                }
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["main_title", config.main_title || defaultConfig.main_title],
                ["subtitle", config.subtitle || defaultConfig.subtitle],
                ["detail_button_text", config.detail_button_text || defaultConfig.detail_button_text],
                ["smg_image_url", config.smg_image_url || defaultConfig.smg_image_url],
                ["zanchetta_image_url", config.zanchetta_image_url || defaultConfig.zanchetta_image_url],
                ["drum_image_url", config.drum_image_url || defaultConfig.drum_image_url],
                ["tumbling800_image_url", config.tumbling800_image_url || defaultConfig.tumbling800_image_url],
                ["tumbling1500_image_url", config.tumbling1500_image_url || defaultConfig.tumbling1500_image_url]
            ]);
        }

        // Function to update machine images
        function updateMachineImage(machineId, imageUrl) {
            const imgElement = document.getElementById(`${machineId}-image`);
            const svgElement = document.getElementById(`${machineId}-default-svg`);
            
            if (imageUrl && imageUrl.trim() !== '') {
                imgElement.src = imageUrl;
                imgElement.style.display = 'block';
                imgElement.classList.remove('hidden');
                imgElement.classList.add('w-40', 'h-40', 'object-cover', 'rounded-full');
                svgElement.style.display = 'none';
                
                // Handle image load error
                imgElement.onload = function() {
                    this.style.display = 'block';
                    this.classList.remove('hidden');
                    this.classList.add('w-40', 'h-40', 'object-cover', 'rounded-full');
                    svgElement.style.display = 'none';
                };
                
                imgElement.onerror = function() {
                    this.style.display = 'none';
                    this.classList.add('hidden');
                    svgElement.style.display = 'block';
                };
            } else {
                // Show default SVG when no URL provided
                imgElement.style.display = 'none';
                imgElement.classList.add('hidden');
                svgElement.style.display = 'block';
            }
        }

        // Home Tab Functions
        function switchHomeTab(tabName) {
            // Remove active class from all home tab buttons
            document.querySelectorAll('.home-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all home tab contents
            document.querySelectorAll('.home-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab content
            document.getElementById(`home-tab-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Update Home Stats
        function updateHomeStats() {
            document.getElementById('home-total-parts').textContent = partsData.length;
            document.getElementById('home-total-stock').textContent = partsData.reduce((sum, part) => sum + part.stock, 0);
            document.getElementById('home-change-parts').textContent = changePartsData.length;
            document.getElementById('home-low-stock').textContent = partsData.filter(p => p.stock <= 5).length;
        }

        // Render Home Parts List - Modern Card Layout with Enhanced Visual Design
        function renderHomePartsList() {
            const container = document.getElementById('home-parts-list');
            
            if (partsData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="mx-auto w-32 h-32 bg-white/10 rounded-full flex items-center justify-center mb-6 backdrop-blur-sm">
                            <svg class="w-16 h-16 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">Belum Ada Part Mesin</h3>
                        <p class="text-white/70 mb-6">Mulai tambahkan part mesin untuk melihat daftar lengkap di sini</p>
                        <div class="flex justify-center">
                            <button onclick="document.querySelector('[onclick*=\"smg\"]').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                                Tambah Part Pertama
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            // Group parts by machine - only include machines that have actual data
            const partsByMachine = {};
            partsData.forEach(part => {
                if (!partsByMachine[part.machineName]) {
                    partsByMachine[part.machineName] = [];
                }
                partsByMachine[part.machineName].push(part);
            });

            // Only show machines that have parts data
            const machinesWithData = Object.keys(partsByMachine);
            
            if (machinesWithData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="mx-auto w-32 h-32 bg-white/10 rounded-full flex items-center justify-center mb-6 backdrop-blur-sm">
                            <svg class="w-16 h-16 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3">Belum Ada Part Mesin</h3>
                        <p class="text-white/70 mb-6">Mulai tambahkan part mesin untuk melihat daftar lengkap di sini</p>
                        <div class="flex justify-center">
                            <button onclick="document.querySelector('[onclick*=\"smg\"]').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                                Tambah Part Pertama
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            // Enhanced machine colors with gradients
            const machineColors = {
                'SMG Yenchen 400': { 
                    bg: 'bg-gradient-to-br from-indigo-500/20 to-indigo-600/30', 
                    text: 'text-indigo-300', 
                    border: 'border-indigo-400/40',
                    accent: 'bg-indigo-500',
                    glow: 'shadow-indigo-500/20'
                },
                'Zanchetta Roto F-200': { 
                    bg: 'bg-gradient-to-br from-purple-500/20 to-purple-600/30', 
                    text: 'text-purple-300', 
                    border: 'border-purple-400/40',
                    accent: 'bg-purple-500',
                    glow: 'shadow-purple-500/20'
                },
                'Drum Mixer': { 
                    bg: 'bg-gradient-to-br from-emerald-500/20 to-emerald-600/30', 
                    text: 'text-emerald-300', 
                    border: 'border-emerald-400/40',
                    accent: 'bg-emerald-500',
                    glow: 'shadow-emerald-500/20'
                },
                'Tumbling 800': { 
                    bg: 'bg-gradient-to-br from-amber-500/20 to-amber-600/30', 
                    text: 'text-amber-300', 
                    border: 'border-amber-400/40',
                    accent: 'bg-amber-500',
                    glow: 'shadow-amber-500/20'
                },
                'Tumbling 1500': { 
                    bg: 'bg-gradient-to-br from-red-500/20 to-red-600/30', 
                    text: 'text-red-300', 
                    border: 'border-red-400/40',
                    accent: 'bg-red-500',
                    glow: 'shadow-red-500/20'
                }
            };

            // Create grid layout for machines
            const machineGroupsHtml = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${machinesWithData.map(machineName => {
                        const machineParts = partsByMachine[machineName];
                        const colors = machineColors[machineName] || { 
                            bg: 'bg-gradient-to-br from-gray-500/20 to-gray-600/30', 
                            text: 'text-gray-300', 
                            border: 'border-gray-400/40',
                            accent: 'bg-gray-500',
                            glow: 'shadow-gray-500/20'
                        };
                        
                        const totalStock = machineParts.reduce((sum, part) => sum + part.stock, 0);
                        const lowStockCount = machineParts.filter(p => p.stock <= 5).length;
                        const mediumStockCount = machineParts.filter(p => p.stock > 5 && p.stock <= 15).length;
                        const highStockCount = machineParts.filter(p => p.stock > 15).length;

                        // Show top 4 parts with enhanced design
                        const partsHtml = machineParts.slice(0, 4).map((part, index) => {
                            const stockStatus = part.stock <= 5 ? 'low' : part.stock <= 15 ? 'medium' : 'high';
                            
                            const stockConfig = {
                                low: { 
                                    bg: 'bg-red-500/20', 
                                    text: 'text-red-300', 
                                    border: 'border-red-400/40',
                                    icon: '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>'
                                },
                                medium: { 
                                    bg: 'bg-yellow-500/20', 
                                    text: 'text-yellow-300', 
                                    border: 'border-yellow-400/40',
                                    icon: '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>'
                                },
                                high: { 
                                    bg: 'bg-green-500/20', 
                                    text: 'text-green-300', 
                                    border: 'border-green-400/40',
                                    icon: '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>'
                                }
                            };

                            const stockStyle = stockConfig[stockStatus];

                            return `
                                <div class="bg-white/5 backdrop-blur-sm rounded-lg p-3 border border-white/10 hover:bg-white/10 transition-all duration-300 group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="w-2 h-2 ${colors.accent} rounded-full"></div>
                                                <h5 class="text-white font-medium text-sm truncate group-hover:text-blue-200 transition-colors">${part.partName}</h5>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <div class="text-white/60 text-xs">
                                                    <span class="font-medium">#{part.partNumber}</span>
                                                </div>
                                                <div class="flex items-center gap-1 px-2 py-1 rounded-full ${stockStyle.bg} ${stockStyle.border} border">
                                                    ${stockStyle.icon}
                                                    <span class="${stockStyle.text} text-xs font-medium">${part.stock}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div class="relative group">
                                <div class="absolute inset-0 ${colors.bg} rounded-2xl blur-xl opacity-50 group-hover:opacity-70 transition-opacity duration-300"></div>
                                <div class="relative bg-white/10 backdrop-blur-lg rounded-2xl p-6 border ${colors.border} hover:border-white/30 transition-all duration-300 ${colors.glow} hover:shadow-2xl">
                                    <!-- Machine Header -->
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="relative">
                                            <div class="w-16 h-16 ${colors.bg} rounded-xl flex items-center justify-center backdrop-blur-sm border ${colors.border}">
                                                <svg class="w-8 h-8 ${colors.text}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                                </svg>
                                            </div>
                                            <div class="absolute -top-1 -right-1 w-6 h-6 ${colors.accent} rounded-full flex items-center justify-center">
                                                <span class="text-white text-xs font-bold">${machineParts.length}</span>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="text-white font-bold text-lg mb-1">${machineName}</h4>
                                            <div class="flex items-center gap-3 text-sm">
                                                <span class="text-white/70">
                                                    <span class="font-semibold text-white">${totalStock}</span> total stok
                                                </span>
                                                ${lowStockCount > 0 ? `<span class="text-red-300 font-medium">⚠️ ${lowStockCount} rendah</span>` : ''}
                                            </div>
                                        </div>
                                        <button onclick="showMachineDetail('${machineName}')" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 backdrop-blur-sm border border-white/20">
                                            <div class="flex items-center gap-2">
                                                <span>Detail</span>
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                </svg>
                                            </div>
                                        </button>
                                    </div>

                                    <!-- Stock Status Bar -->
                                    <div class="mb-4">
                                        <div class="flex items-center justify-between text-xs text-white/60 mb-2">
                                            <span>Status Stok</span>
                                            <span>${machineParts.length} parts</span>
                                        </div>
                                        <div class="flex h-2 bg-white/10 rounded-full overflow-hidden">
                                            ${highStockCount > 0 ? `<div class="bg-green-500 flex-shrink-0" style="width: ${(highStockCount / machineParts.length) * 100}%"></div>` : ''}
                                            ${mediumStockCount > 0 ? `<div class="bg-yellow-500 flex-shrink-0" style="width: ${(mediumStockCount / machineParts.length) * 100}%"></div>` : ''}
                                            ${lowStockCount > 0 ? `<div class="bg-red-500 flex-shrink-0" style="width: ${(lowStockCount / machineParts.length) * 100}%"></div>` : ''}
                                        </div>
                                        <div class="flex items-center justify-between text-xs mt-2">
                                            <div class="flex items-center gap-4">
                                                ${highStockCount > 0 ? `<div class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full"></div><span class="text-green-300">${highStockCount} Tinggi</span></div>` : ''}
                                                ${mediumStockCount > 0 ? `<div class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-500 rounded-full"></div><span class="text-yellow-300">${mediumStockCount} Sedang</span></div>` : ''}
                                                ${lowStockCount > 0 ? `<div class="flex items-center gap-1"><div class="w-2 h-2 bg-red-500 rounded-full"></div><span class="text-red-300">${lowStockCount} Rendah</span></div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Parts Grid -->
                                    <div class="space-y-2">
                                        <h5 class="text-white/80 font-medium text-sm mb-3">Parts Terbaru:</h5>
                                        <div class="grid grid-cols-1 gap-2">
                                            ${partsHtml}
                                        </div>
                                        ${machineParts.length > 4 ? `
                                            <div class="text-center pt-3 border-t border-white/10">
                                                <button onclick="showMachineDetail('${machineName}')" class="text-blue-300 hover:text-blue-200 font-medium text-sm transition-colors hover:underline">
                                                    Lihat ${machineParts.length - 4} part lainnya →
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = machineGroupsHtml;
        }

        // Render Home Change Parts List - Grouped by Machine (Only show machines with data)
        function renderHomeChangePartsList() {
            const container = document.getElementById('home-change-parts-list');
            
            if (changePartsData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-white/70">
                        <svg class="w-16 h-16 mx-auto mb-4 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <h3 class="text-lg font-medium mb-2">Belum Ada Change Part</h3>
                        <p class="text-sm">Klik detail mesin untuk menambahkan change part</p>
                    </div>
                `;
                return;
            }

            // Group change parts by machine - only include machines that have actual data
            const changePartsByMachine = {};
            changePartsData.forEach(part => {
                if (!changePartsByMachine[part.machineName]) {
                    changePartsByMachine[part.machineName] = [];
                }
                changePartsByMachine[part.machineName].push(part);
            });

            // Only show machines that have change parts data
            const machinesWithData = Object.keys(changePartsByMachine);
            
            if (machinesWithData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-white/70">
                        <svg class="w-16 h-16 mx-auto mb-4 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <h3 class="text-lg font-medium mb-2">Belum Ada Change Part</h3>
                        <p class="text-sm">Klik detail mesin untuk menambahkan change part</p>
                    </div>
                `;
                return;
            }

            // Get machine colors
            const machineColors = {
                'SMG Yenchen 400': { bg: 'bg-indigo-500/20', text: 'text-indigo-300', border: 'border-indigo-500/30' },
                'Zanchetta Roto F-200': { bg: 'bg-purple-500/20', text: 'text-purple-300', border: 'border-purple-500/30' },
                'Drum Mixer': { bg: 'bg-emerald-500/20', text: 'text-emerald-300', border: 'border-emerald-500/30' },
                'Tumbling 800': { bg: 'bg-amber-500/20', text: 'text-amber-300', border: 'border-amber-500/30' },
                'Tumbling 1500': { bg: 'bg-red-500/20', text: 'text-red-300', border: 'border-red-500/30' }
            };

            const machineGroupsHtml = machinesWithData.map(machineName => {
                const machineChangeParts = changePartsByMachine[machineName];
                const colors = machineColors[machineName] || { bg: 'bg-gray-500/20', text: 'text-gray-300', border: 'border-gray-500/30' };
                
                const changePartsHtml = machineChangeParts.slice(0, 5).map(part => {
                    return `
                        <div class="part-card rounded-lg p-3 border ${colors.border}">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h5 class="text-white font-medium text-sm mb-1">${part.partName}</h5>
                                    <div class="flex items-center justify-between">
                                        <div class="text-white/70 text-xs">
                                            <span class="font-medium">Part #:</span> ${part.partNumber}
                                        </div>
                                        <div class="text-white/60 text-xs">
                                            <span class="font-medium">Vendor:</span> ${part.vendor}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                const totalChanges = machineChangeParts.length;
                const recentChanges = machineChangeParts.filter(p => {
                    const changeDate = new Date(p.createdAt);
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    return changeDate >= thirtyDaysAgo;
                }).length;

                return `
                    <div class="part-card rounded-xl p-4 border ${colors.border}">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 ${colors.bg} rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 ${colors.text}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-white font-semibold text-lg">${machineName}</h4>
                                <div class="flex items-center gap-4 text-sm text-white/70">
                                    <span><strong>${totalChanges}</strong> change parts</span>
                                    ${recentChanges > 0 ? `<span class="text-green-300"><strong>${recentChanges}</strong> baru (30 hari)</span>` : ''}
                                </div>
                            </div>
                            <button onclick="showMachineDetail('${machineName}')" class="text-blue-300 hover:text-blue-200 text-sm font-medium transition-colors">
                                Detail →
                            </button>
                        </div>
                        
                        <div class="space-y-2">
                            ${changePartsHtml}
                            ${machineChangeParts.length > 5 ? `
                                <div class="text-center pt-2">
                                    <button onclick="showMachineDetail('${machineName}')" class="text-blue-300 hover:text-blue-200 font-medium text-xs transition-colors">
                                        +${machineChangeParts.length - 5} change part lainnya
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = machineGroupsHtml;
        }

        // Show Machine Detail Function
        function showMachineDetail(machineName) {
            // Find the machine type based on name
            let machineType = 'smg'; // default
            
            switch(machineName) {
                case 'SMG Yenchen 400':
                    machineType = 'smg';
                    break;
                case 'Zanchetta Roto F-200':
                    machineType = 'zanchetta';
                    break;
                case 'Drum Mixer':
                    machineType = 'drum';
                    break;
                case 'Tumbling 800':
                    machineType = 'tumbling800';
                    break;
                case 'Tumbling 1500':
                    machineType = 'tumbling1500';
                    break;
            }
            
            // Open the detail modal for the specific machine
            showDetail(machineType);
        }

        // Initialize SDKs
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Data SDK
            initializeDataSDK();
            
            // Load data from Supabase on page load
            await loadAndUpdatePartsData();
            
            // Initialize default images on page load
            updateMachineImage('smg', defaultConfig.smg_image_url);
            updateMachineImage('zanchetta', defaultConfig.zanchetta_image_url);
            updateMachineImage('drum', defaultConfig.drum_image_url);
            updateMachineImage('tumbling800', defaultConfig.tumbling800_image_url);
            updateMachineImage('tumbling1500', defaultConfig.tumbling1500_image_url);
            
            // Initialize home stats and lists
            updateHomeStats();
            renderHomePartsList();
            renderHomeChangePartsList();
        });

        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                render,
                mapToCapabilities,
                mapToEditPanelValues
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992d8b8bc2ca7156',t:'MTc2MTE4MzgyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>